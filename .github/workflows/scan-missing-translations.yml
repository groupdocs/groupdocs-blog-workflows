name: Daily Scan Missing Translations

on:
  schedule:
    # Run every day at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  scan:
    runs-on: self-hosted
    permissions:
      contents: write
    steps:
      - name: Checkout blog-workflows repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_PAT }}

      - name: Checkout GroupDocs Blog repo
        uses: actions/checkout@v4
        with:
          repository: groupdocs/groupdocs-blog
          token: ${{ secrets.REPO_PAT }}
          path: blog-repo
          submodules: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r tools/missing-translations-scanner/requirements.txt
          pip install -r tools/redmine-activity-reporter/requirements.txt

      - name: Run translation scanner
        run: |
          python tools/missing-translations-scanner/scan_missing_translations.py \
            --content blog-repo/content \
            --config blog-repo/config.yml \
            --output translations_scan_report.json

      - name: Generate markdown report
        run: |
          python tools/missing-translations-scanner/generate_markdown_report.py \
            --input translations_scan_report.json \
            --output translation_status.md

      - name: Update README with translation status
        run: |
          python tools/missing-translations-scanner/update_readme.py \
            --readme README.md \
            --status translation_status.md

      - name: Check for missing translations
        id: check-missing
        run: |
          set -euo pipefail
          # Check if there are any posts with missing translations
          posts_with_missing=$(python -c "import json; report = json.load(open('translations_scan_report.json')); print(report['summary']['posts_with_missing_translations'])")
          if [ "$posts_with_missing" -gt "0" ]; then
            echo "has_missing=true" >> $GITHUB_OUTPUT
          else
            echo "has_missing=false" >> $GITHUB_OUTPUT
          fi

      - name: Log to Redmine
        if: steps.check-missing.outputs.has_missing == 'true'
        env:
          REDMINE_ENDPOINT: ${{ secrets.REDMINE_ENDPOINT }}
          REDMINE_API_KEY: ${{ secrets.REDMINE_API_KEY }}
          REDMINE_ISSUE_ID: ${{ secrets.REDMINE_ISSUE_ID_BLOG_LOCALIZATION }}
          REDMINE_ACTIVITY_ID: ${{ secrets.REDMINE_ACTIVITY_ID_LOCALIZATION }}
          REDMINE_REPORT_TO_USER: ${{ secrets.REDMINE_REPORT_TO_USER }}
          REDMINE_HOURS: 0.5
        run: |
          set -euo pipefail
          
          # Generate full Redmine comment from scan report and save to file
          python tools/missing-translations-scanner/create_redmine_comment.py \
            --report-json translations_scan_report.json \
            --output redmine_comment.txt
          
          # Generate simplified time comment
          python tools/missing-translations-scanner/create_simplified_time_comment.py \
            --report-json translations_scan_report.json \
            --output redmine_time_comment.txt
          
          # Add full comment to the issue and log time with simplified comment
          python tools/blog-post-translator/log_to_redmine.py

      - name: Commit changes
        shell: bash
        env:
          REPO_PAT: ${{ secrets.REPO_PAT }}
        run: |
          set -euo pipefail
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git remote set-url origin https://x-access-token:${REPO_PAT}@github.com/${{ github.repository }}.git
          git add translations_scan_report.json README.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update translation status report"
            git push origin HEAD
          fi
